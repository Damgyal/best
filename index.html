<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live MCQ OMR Scanner</title>
<style>
  body { font-family: system-ui, -apple-system, Roboto, Arial; margin:0; padding:0; background:#f4f7fb; color:#111827; }
  header { background:#1f6feb; color:white; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; }
  header h1 { margin:0; font-size:1.3rem; }
  .container { max-width:900px; background:white; margin:2rem auto; padding:2rem; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.05); }
  h2 { border-bottom:2px solid #e5e7eb; padding-bottom:4px; }
  label { font-weight:600; margin-top:12px; display:block; }
  input, select { width:100%; padding:8px; margin-top:4px; border:1px solid #cbd5e1; border-radius:6px; }
  button { background:#1f6feb; color:white; padding:10px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:600; margin-top:10px; }
  button:hover { background:#155ab6; }
  .answers select { width:60px; text-transform:uppercase; text-align:center; margin-right:6px; margin-bottom:6px; }
  .row { display:flex; gap:6px; align-items:center; margin-bottom:6px; flex-wrap:wrap; }
  #results { margin-top:20px; background:#f9fafb; padding:10px; border-radius:8px; }
  .score { font-weight:bold; color:#1f6feb; }
  video { width:100%; border-radius:10px; margin-top:10px; }
  canvas { border:1px solid #cbd5e1; border-radius:10px; display:block; margin-top:10px; max-width:100%; }
  #cameraControls { display:flex; gap:10px; margin-top:10px; }
  #zoomRange { width:150px; }
</style>
</head>
<body>

<header>
  <h1>Live MCQ OMR Scanner</h1>
</header>

<div class="container">
<h2>Answer Key Setup</h2>
<label>Number of Questions:</label><input type="number" id="numQuestions" min="1" max="100" value="5">
<button id="generateBtn">Generate Answer Inputs</button>
<div id="answerInputs" class="answers"></div>

<h2>Live OMR Scan</h2>
<video id="video" autoplay playsinline></video>
<canvas id="omrCanvas"></canvas>

<div id="cameraControls">
  <button id="snapBtn">Snap</button>
  <button id="resetBtn">Reset Camera</button>
  <label>Zoom:
    <input type="range" id="zoomRange" min="1" max="3" step="0.1" value="1">
  </label>
</div>

<button id="analyzeBtn">Analyze OMR</button>
<div id="results"></div>
</div>

<script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
<script>
let video=document.getElementById('video');
let omrCanvas=document.getElementById('omrCanvas');
let ctx=omrCanvas.getContext('2d');
let generateBtn=document.getElementById('generateBtn');
let answerInputs=document.getElementById('answerInputs');
let snapBtn=document.getElementById('snapBtn');
let resetBtn=document.getElementById('resetBtn');
let zoomRange=document.getElementById('zoomRange');
let analyzeBtn=document.getElementById('analyzeBtn');
let resultsDiv=document.getElementById('results');

let correctAnswers=[], warped=null, stream=null, currentZoom=1;

// Generate correct answer inputs
generateBtn.addEventListener('click', ()=>{
  const n=parseInt(document.getElementById('numQuestions').value);
  answerInputs.innerHTML='';
  for(let i=1;i<=n;i++){
    const row=document.createElement('div');
    row.className='row';
    row.innerHTML=`<label>Q${i}:</label>
      <select id="ans${i}">
        <option value="">Select</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
        <option value="D">D</option>
      </select>`;
    answerInputs.appendChild(row);
  }
});

// Camera access
async function startCamera(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); }
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject=stream;
  }catch(err){ alert("Camera error: "+err);}
}
startCamera();

// Snap button
snapBtn.addEventListener('click', ()=>{
  omrCanvas.width=video.videoWidth;
  omrCanvas.height=video.videoHeight;
  ctx.drawImage(video,0,0,omrCanvas.width,omrCanvas.height);
  warped=cv.imread(omrCanvas); // Save snapped frame for analysis
});

// Reset camera
resetBtn.addEventListener('click', ()=>{
  startCamera();
  warped=null;
  ctx.clearRect(0,0,omrCanvas.width,omrCanvas.height);
});

// Zoom control
zoomRange.addEventListener('input', ()=>{
  currentZoom=parseFloat(zoomRange.value);
  omrCanvas.style.transform=`scale(${currentZoom})`;
});

// --- AI-style OMR reading ---
function detectOMRAnswers(mat,numQuestions){
    const gray = new cv.Mat();
    cv.cvtColor(mat, gray, cv.COLOR_RGBA2GRAY);
    const blur = new cv.Mat();
    cv.GaussianBlur(gray, blur, new cv.Size(5,5), 0);
    const thresh = new cv.Mat();
    cv.adaptiveThreshold(blur, thresh, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 25, 10);

    const contours = new cv.MatVector();
    const hierarchy = new cv.Mat();
    cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    let bubbles=[];
    for(let i=0;i<contours.size();i++){
        const cnt=contours.get(i);
        const rect=cv.boundingRect(cnt);
        const aspect=rect.width/rect.height;
        const area=rect.width*rect.height;
        if(aspect>0.7 && aspect<1.3 && area>200 && area<2000){
            bubbles.push({rect, cx:rect.x+rect.width/2, cy:rect.y+rect.height/2});
        }
        cnt.delete();
    }

    bubbles.sort((a,b)=>a.cy-b.cy);
    const grouped=[];
    const yThresh=20;
    for(const b of bubbles){
        let found=false;
        for(const g of grouped){
            if(Math.abs(g[0].cy - b.cy)<yThresh){ g.push(b); found=true; break;}
        }
        if(!found) grouped.push([b]);
    }
    grouped.forEach(row=>row.sort((a,b)=>a.cx-b.cx));

    const answers=[];
    const rows=Math.min(numQuestions,grouped.length);
    for(let i=0;i<rows;i++){
        const row=grouped[i];
        let fillRatios=[];
        for(let j=0;j<row.length;j++){
            const r=row[j].rect;
            const roi=thresh.roi(r);
            const fill=cv.countNonZero(roi)/(r.width*r.height);
            fillRatios.push({idx:j, fill});
            roi.delete();
        }
        const maxFill=Math.max(...fillRatios.map(f=>f.fill));
        const marked=fillRatios.filter(f=>f.fill>maxFill*0.7);
        if(marked.length===0) answers.push("None");
        else if(marked.length>1) answers.push("Multiple");
        else answers.push(["A","B","C","D"][marked[0].idx]||"?");
    }

    gray.delete(); blur.delete(); thresh.delete(); contours.delete(); hierarchy.delete();
    return answers;
}

// --- Analyze button ---
analyzeBtn.addEventListener('click', ()=>{
    if(!warped){ alert("Snap the OMR sheet first"); return; }
    const n=parseInt(document.getElementById('numQuestions').value);
    correctAnswers=[];
    for(let i=1;i<=n;i++){
        const val=document.getElementById('ans'+i)?.value.trim().toUpperCase();
        if(!val.match(/^[A-D]$/)){ alert("Enter valid answers A-D"); return; }
        correctAnswers.push(val);
    }
    const detected=detectOMRAnswers(warped, n);
    let score=0, details=[];
    for(let i=0;i<n;i++){
        let stu=detected[i];
        let status="❌";
        if(stu===correctAnswers[i]){ status="✅"; score++; }
        details.push(`<tr><td>${i+1}</td><td>${stu}</td><td>${correctAnswers[i]}</td><td>${status}</td></tr>`);
    }
    resultsDiv.innerHTML=`<h3>Results</h3>
        <table border="1" cellspacing="0" cellpadding="6">
        <tr><th>Q#</th><th>Student</th><th>Correct</th><th>Status</th></tr>
        ${details.join("")}</table>
        <p class="score">Score: ${score}/${n}</p>`;
});
</script>
</body>
</html>
